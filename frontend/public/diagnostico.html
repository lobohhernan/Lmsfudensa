<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico - LMS Fudensa</title>
  <style>
    body {
      font-family: monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .container {
      background: #252526;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #3e3e42;
    }
    h1 { color: #0B5FFF; margin-bottom: 20px; }
    h2 { color: #4FC3F7; margin-top: 20px; border-bottom: 1px solid #3e3e42; padding-bottom: 10px; }
    .section {
      margin: 15px 0;
      padding: 15px;
      background: #1e1e1e;
      border-left: 3px solid #0B5FFF;
    }
    .success { border-left-color: #4EC9B0; }
    .error { border-left-color: #F48771; }
    .warning { border-left-color: #DCD7A0; }
    .info { border-left-color: #569CD6; }
    button {
      background: #0B5FFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #094acc;
    }
    button.danger {
      background: #F48771;
    }
    button.danger:hover {
      background: #e06060;
    }
    code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 3px;
      display: block;
      margin: 5px 0;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .status-ok { color: #4EC9B0; }
    .status-err { color: #F48771; }
    .status-warn { color: #DCD7A0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico Supabase - LMS Fudensa</h1>
    
    <button onclick="runDiagnostics()">‚ñ∂Ô∏è Ejecutar Diagn√≥stico Completo</button>
    <button onclick="clearAllAndReload()" class="danger">üóëÔ∏è Limpiar Todo y Recargar</button>
    <button onclick="location.reload()">üîÑ Recargar P√°gina</button>

    <div id="output"></div>
  </div>

  <script>
    const log = (title, content, type = 'info') => {
      const output = document.getElementById('output');
      const section = document.createElement('div');
      section.className = `section ${type}`;
      
      let contentStr = content;
      if (typeof content === 'object') {
        try {
          contentStr = JSON.stringify(content, null, 2);
        } catch (e) {
          contentStr = String(content);
        }
      }
      
      section.innerHTML = `<strong>${title}</strong><code>${contentStr}</code>`;
      output.appendChild(section);
    };

    async function runDiagnostics() {
      document.getElementById('output').innerHTML = '';
      
      log('‚è±Ô∏è Timestamp', new Date().toISOString());
      
      // 1. Verificar localStorage
      try {
        const localStorageSize = new Blob(Object.values(localStorage)).size;
        log('üì¶ LocalStorage Size', {
          itemCount: localStorage.length,
          sizeBytes: localStorageSize,
          sizeMB: (localStorageSize / 1024 / 1024).toFixed(2),
          firstKeys: Object.keys(localStorage).slice(0, 5)
        }, localStorage.length > 0 ? 'info' : 'warning');
      } catch (e) {
        log('‚ö†Ô∏è LocalStorage Error', e.message, 'warning');
      }

      // 2. Verificar sessionStorage
      try {
        const sessionStorageSize = new Blob(Object.values(sessionStorage)).size;
        log('üì¶ SessionStorage Size', {
          itemCount: sessionStorage.length,
          sizeBytes: sessionStorageSize,
          sizeMB: (sessionStorageSize / 1024 / 1024).toFixed(2),
          firstKeys: Object.keys(sessionStorage).slice(0, 5)
        }, 'info');
      } catch (e) {
        log('‚ö†Ô∏è SessionStorage Error', e.message, 'warning');
      }

      // 3. Verificar cookies
      try {
        const cookieCount = document.cookie.split(';').length;
        log('üç™ Cookies', {
          count: cookieCount,
          sampleSize: new Blob([document.cookie]).size,
          cookies: document.cookie.slice(0, 300)
        }, 'info');
      } catch (e) {
        log('‚ö†Ô∏è Cookies Error', e.message, 'warning');
      }

      // 4. Verificar Navigator
      log('üåê Network & Browser', {
        online: navigator.onLine,
        userAgent: navigator.userAgent.slice(0, 100),
        language: navigator.language,
        hardwareConcurrency: navigator.hardwareConcurrency
      }, navigator.onLine ? 'success' : 'error');

      // 5. Verificar IndexedDB
      try {
        if (window.indexedDB) {
          const dbs = await indexedDB.databases();
          log('üóÑÔ∏è IndexedDB', {
            available: true,
            databases: dbs.length,
            dbNames: dbs.map(db => db.name)
          }, dbs.length > 0 ? 'info' : 'warning');
        } else {
          log('üóÑÔ∏è IndexedDB', 'Not available', 'warning');
        }
      } catch (e) {
        log('‚ö†Ô∏è IndexedDB Error', e.message, 'warning');
      }

      // 6. Verificar Service Workers
      try {
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          log('üîß Service Workers', {
            available: true,
            registrations: registrations.length,
            scopes: registrations.map(r => r.scope)
          }, registrations.length > 0 ? 'info' : 'warning');
        } else {
          log('üîß Service Workers', 'Not available', 'warning');
        }
      } catch (e) {
        log('‚ö†Ô∏è Service Workers Error', e.message, 'warning');
      }

      // 7. Verificar Storage API
      try {
        if ('storage' in navigator && 'estimate' in navigator.storage) {
          const estimate = await navigator.storage.estimate();
          log('üíæ Storage API (Quota)', {
            usageBytes: estimate.usage,
            usageMB: (estimate.usage / 1024 / 1024).toFixed(2),
            quotaBytes: estimate.quota,
            quotaGB: (estimate.quota / 1024 / 1024 / 1024).toFixed(2),
            percentUsed: ((estimate.usage / estimate.quota) * 100).toFixed(2) + '%'
          }, estimate.usage > estimate.quota * 0.8 ? 'warning' : 'success');
        } else {
          log('üíæ Storage API', 'Not available', 'warning');
        }
      } catch (e) {
        log('‚ö†Ô∏è Storage API Error', e.message, 'warning');
      }

      // 8. Verificar si hay sesi√≥n de Supabase
      try {
        const supabaseAuthKey = Object.keys(localStorage).find(k => k.includes('supabase'));
        if (supabaseAuthKey) {
          const authData = localStorage.getItem(supabaseAuthKey);
          const authSize = new Blob([authData]).size;
          log('üîê Supabase Session', {
            found: true,
            key: supabaseAuthKey,
            sizeBytes: authSize,
            sizeMB: (authSize / 1024 / 1024).toFixed(2),
            preview: authData?.slice(0, 100) + '...'
          }, 'info');
        } else {
          log('üîê Supabase Session', 'Not found in localStorage', 'warning');
        }
      } catch (e) {
        log('‚ö†Ô∏è Supabase Session Error', e.message, 'warning');
      }

      // 9. Resumen
      log('‚úÖ Diagn√≥stico Completado', {
        timestamp: new Date().toISOString(),
        nextStep: 'Si ves valores altos en LocalStorage (>100MB), deber√≠as limpiar con "Limpiar Todo y Recargar"'
      }, 'success');
    }

    function testStorage(type) {
      try {
        const test = '__test__';
        const obj = type === 'localStorage' ? window.localStorage : window.sessionStorage;
        obj.setItem(test, test);
        const result = obj.getItem(test) === test;
        obj.removeItem(test);
        return result;
      } catch (e) {
        return false;
      }
    }

    function clearAllAndReload() {
      if (confirm('Esto borrar√° TODOS los datos del navegador. ¬øContinuar?')) {
        try {
          // Clear localStorage
          localStorage.clear();
          
          // Clear sessionStorage
          sessionStorage.clear();
          
          // Clear cookies
          document.cookie.split(";").forEach(c => {
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
          });

          log('‚úÖ Storage Limpiado', 'Recargando en 2 segundos...', 'success');

          // Clear service workers
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(reg => reg.unregister());
              setTimeout(() => window.location.href = '/', 2000);
            });
          } else {
            setTimeout(() => window.location.href = '/', 2000);
          }
        } catch (e) {
          log('‚ùå Error limpiando', e.message, 'error');
        }
      }
    }

    // Run on load
    window.addEventListener('load', () => {
      log('üöÄ P√°gina Cargada', 'Haz clic en "Ejecutar Diagn√≥stico Completo" para ver detalles', 'success');
    });
  </script>
</body>
</html>
